{% extends "base.html" %}
{% block title %}–ü—Ä–∞–∫—Ç–∏–∫–∞: {{ lesson.title }} - Python Master{% endblock %}
{% block content %}
<div>
    <h1 style="margin-bottom: 10px;">–ü—Ä–∞–∫—Ç–∏–∫–∞: {{ lesson.title }}</h1>
    <p style="color: #666; margin-bottom: 30px;">{{ lesson.exercise }}</p>

    <div class="card" style="margin-bottom: 30px;">
        <h3 style="margin-bottom: 15px;">‚úèÔ∏è –ù–∞–ø–∏—à–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ:</h3>
        <textarea id="code-editor" style="width: 100%; height: 300px; font-family: 'Courier New', monospace; padding: 15px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"># –í–∞—à –∫–æ–¥ –∑–¥–µ—Å—å</textarea>

        <div style="margin-top: 20px; display: flex; gap: 15px;">
            <button onclick="checkCode()" class="btn btn-primary" id="check-btn">
                –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ
            </button>
            <button onclick="showSolution()" class="btn btn-secondary">
                –ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ
            </button>
        </div>

        <div id="result" style="margin-top: 20px;"></div>
    </div>

    <div style="display: flex; gap: 15px;">
        <a href="/lesson/{{ lesson.id }}" class="btn btn-secondary">
            ‚Üê –ù–∞–∑–∞–¥ –∫ —Ç–µ–æ—Ä–∏–∏
        </a>
        <a href="/dashboard" class="btn btn-secondary">
            –ö —É—Ä–æ–∫–∞–º
        </a>
    </div>
</div>

<script>
    const lessonId = {{ lesson.id }};

    function checkCode() {
        const code = document.getElementById('code-editor').value;
        const btn = document.getElementById('check-btn');
        const result = document.getElementById('result');

        btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
        btn.disabled = true;

        fetch('/check_code', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                lesson_id: lessonId,
                code: code
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                result.innerHTML = `<div style="background: #d4edda; color: #155724; padding: 15px; border-radius: 5px;">
                    ‚úÖ ${data.message}
                </div>`;

                if (data.level_up) {
                    setTimeout(() => {
                        alert('üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –ø–æ–≤—ã—Å–∏–ª–∏ —É—Ä–æ–≤–µ–Ω—å!');
                    }, 500);
                }
            } else {
                result.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                    ‚ùå ${data.message}
                </div>`;
            }
        })
        .catch(error => {
            result.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px;">
                –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            </div>`;
        })
        .finally(() => {
            btn.innerHTML = '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ—à–µ–Ω–∏–µ';
            btn.disabled = false;
        });
    }

    function showSolution() {
        const solution = `{{ lesson.solution }}`;
        document.getElementById('code-editor').value = solution;
    }

    // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            checkCode();
            e.preventDefault();
        }
    });
</script>
{% endblock %}